# üîß Soluci√≥n para Error 403 en Tryton

## üö® Problema Identificado

Los logs muestran que Tryton est√° devolviendo errores 403 (Forbidden) para las peticiones OPTIONS:

```
werkzeug.exceptions.Forbidden: 403 Forbidden: You don't have the permission to access the requested resource.
```

Esto indica que la configuraci√≥n de CORS no est√° funcionando correctamente.

## ‚úÖ Soluci√≥n Paso a Paso

### 1. Verificar la Configuraci√≥n Actual

Tu archivo de configuraci√≥n debe estar en una ubicaci√≥n como:
- `/etc/tryton/trytond.conf`
- `/opt/gnuhealth/his-50/etc/trytond.conf`
- O donde lo hayas especificado

### 2. Configuraci√≥n Correcta de CORS

Tu archivo de configuraci√≥n debe tener **TODAS** estas secciones:

```ini
# Generated by gnuhealth-control
[database]
uri = postgresql://:5432
path = /opt/gnuhealth/his-50/attach
list = True

[web]
# Listen to all network interfaces.
listen = 0.0.0.0:8000
root = /home/gnuhealth/Downloads/a/
list = True

[jsonrpc]
listen = 0.0.0.0:8000

# üîß ESTA SECCI√ìN ES CR√çTICA - DEBE ESTAR PRESENTE
[web_cors]
enabled = True
origins = *
methods = GET,POST,PUT,DELETE,OPTIONS
headers = Content-Type,Authorization

# üîß AGREGAR ESTA SECCI√ìN TAMBI√âN
[web_cors_preflight]
enabled = True
```

### 3. Verificar que la Configuraci√≥n se Aplic√≥

```bash
# Verificar que el archivo existe y tiene el contenido correcto
cat /ruta/a/tu/trytond.conf | grep -A 10 "web_cors"

# Deber√≠as ver algo como:
# [web_cors]
# enabled = True
# origins = *
# methods = GET,POST,PUT,DELETE,OPTIONS
# headers = Content-Type,Authorization
```

### 4. Reiniciar Tryton Completamente

**IMPORTANTE:** Despu√©s de cambiar la configuraci√≥n, debes reiniciar completamente:

```bash
# Detener Tryton
gnuhealth-control stop
# o
pkill trytond

# Esperar unos segundos
sleep 5

# Iniciar nuevamente con la configuraci√≥n
gnuhealth-control start
# o
trytond -c /ruta/a/tu/trytond.conf
```

### 5. Verificar que CORS Est√© Funcionando

```bash
# Probar una petici√≥n OPTIONS
curl -X OPTIONS http://localhost:8000/ \
  -H "Origin: http://localhost:5173" \
  -H "Access-Control-Request-Method: POST" \
  -H "Access-Control-Request-Headers: Content-Type" \
  -v
```

Deber√≠as ver headers como:
```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS
Access-Control-Allow-Headers: Content-Type,Authorization
```

## üö® Problemas Comunes

### Problema: La secci√≥n [web_cors] no existe

**Soluci√≥n:** Agrega la secci√≥n completa al archivo de configuraci√≥n.

### Problema: Tryton no reconoce la configuraci√≥n

**Soluci√≥n:** Verifica que est√©s usando el archivo de configuraci√≥n correcto:
```bash
# Verificar qu√© archivo est√° usando
ps aux | grep trytond
# Busca la l√≠nea que contenga -c o --config-file
```

### Problema: Permisos de archivo

**Soluci√≥n:** Verifica los permisos del archivo de configuraci√≥n:
```bash
ls -la /ruta/a/tu/trytond.conf
# Deber√≠a ser legible por el usuario que ejecuta Tryton
```

## üîç Verificaci√≥n en los Logs

Despu√©s de reiniciar, los logs deber√≠an mostrar algo como:

```
[Sun Aug 31 22:59:22 2025] INFO:trytond.wsgi:<Request 127.0.0.1 'http://localhost:8000/' [OPTIONS]>
[Sun Aug 31 22:59:22 2025] INFO:werkzeug:127.0.0.1 - - [31/Aug/2025 22:59:22] "OPTIONS / HTTP/1.1" 200 -
```

**NOTA:** El c√≥digo de estado debe ser 200, no 403.

## üõ†Ô∏è Configuraci√≥n Alternativa

Si el problema persiste, puedes intentar una configuraci√≥n m√°s espec√≠fica:

```ini
[web_cors]
enabled = True
origins = http://localhost:5173,http://127.0.0.1:5173
methods = GET,POST,PUT,DELETE,OPTIONS
headers = Content-Type,Authorization,X-Requested-With

[web_cors_preflight]
enabled = True
max_age = 86400
```

## üìû Comandos de Verificaci√≥n

```bash
# Verificar configuraci√≥n
trytond --config-file=/ruta/a/tu/trytond.conf --check-config

# Ver logs en tiempo real
tail -f /var/log/trytond.log

# Probar conexi√≥n completa
curl -X POST http://localhost:8000/ \
  -H "Content-Type: application/json" \
  -H "Origin: http://localhost:5173" \
  -d '{"jsonrpc":"2.0","method":"common.db.list","params":[],"id":1}'
```

## üéØ Pr√≥ximos Pasos

1. **Verifica que la secci√≥n `[web_cors]` est√© presente** en tu archivo de configuraci√≥n
2. **Reinicia completamente Tryton** despu√©s de hacer cambios
3. **Verifica los logs** para confirmar que no hay m√°s errores 403
4. **Prueba la aplicaci√≥n React** nuevamente

Una vez que hayas aplicado estos cambios, tu aplicaci√≥n React deber√≠a poder conectarse sin problemas.
